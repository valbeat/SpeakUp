<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script type="text/javascript" src="./js/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="./js/msgpack.codec.js"></script>
<script type="text/javascript" src="./js/libspeexdsp.js"></script>
<script type="text/javascript" src="./js/resampler.min.js"></script>
<script type="text/javascript" src="./js/speechrec.min.js"></script>
<script type="text/javascript" src="./js/jquery-ui-1.10.4.min.js"></script>
<script type="text/javascript" src="./js/sample-preference-view.js"></script>
<script type="text/javascript" src="./js/sample-recognition-view.js"></script>
<script type="text/javascript">

$(document).ready(function(){

	SpeechRec.config({ 'ApiKey':'6164334f445a527577746e64627576717a625841623443556f794f625372617a4d37717635526d50712e39' });
	SpeechRec.on_result(function(result){
    // 認識結果をテキストボックスに表示
		$('#result_textarea').val(result.candidates[0].speech);

		var context = new AudioContext();

    function tts(input) {
      var textToSpeech = function() {

        var url = 'https://api.apigw.smt.docomo.ne.jp/virtualNarrator/v1/textToSpeech';
        var APIKEY = '6164334f445a527577746e64627576717a625841623443556f794f625372617a4d37717635526d50712e39';

        var request = new XMLHttpRequest();
        request.open('POST', url + '?APIKEY=' + APIKEY);
        request.responseType = 'arraybuffer';
         //request.responseType = 'application/json';
        request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        request.onload = function(evt) {
          var onDecode = function(buf) {
            playSound(buf);
          };

          var onDecodeError = function(err) {
            console.log('onDecodeError:', err);
          };

          context.decodeAudioData(request.response, onDecode, onDecodeError);

          function playSound(buffer) {
            var source = context.createBufferSource();
            source.buffer = buffer;
            source.connect(context.destination);
            source.start(0);
          }
        };
        var url = 'https://api.apigw.smt.docomo.ne.jp/dialogue/v1/dialogue';
        var APIKEY = '4132387542305945724c6e71766a46507a4c2e363566436f67664644567053444e5230324c565465716f42';
        var req = function(utt) {
        	var request = new XMLHttpRequest();
          request.open('POST', url + '?APIKEY=' + APIKEY);
          request.responseType = 'application/json';
          request.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');

          // 結果のロード時に実行される関数
        	request.onload = function(evt) {

            console.log(request.response);

            // JSONにパースしてサーバーに送る用のデータを作成
            requestJson = JSON.parse(request.response);
            message =  '{ "VRResult" : "' + requestJson.yomi + '" }'

            // Ajaxでデータを送信
            $.ajax({
              url: '/vrresult', //呼び出すAPI
              type: 'POST',
              dataType: 'json', //APIが出力するデータのタイプ
              contentType: 'application/json',
              data: message //APIが受け付けるパラメータ
            }).done(function(data) {
              console.log(data); //consoleに表示
            }).fail(function(data) {
              console.log(data);
            });
        	}
        	var params = {"utt": utt};
        	var body = Object.keys(params).map(function(key) {
            return key + '=' + params[key]
          }).join('&');
        	request.send(JSON.stringify(params));
        }

        var new_txt = JSON.stringify(result, undefined, 2);
        req(new_txt);

        //送信するパラメータを設定
        var params = {
          text:request.response,
          speaker: 'hikari',
        };
        //送信する body 文字列を作成
        var body = Object.keys(params).map(function(key) {
          return key + '=' + params[key]
        }).join('&');
        request.send(body);
      }
      textToSpeech();
    }
    tts();

    console.warn('▲コールバック関数 on_result が実行されました( 音声認識を停止しました / 認識結果を得ました ) at ' + (new Date).toLocaleString());
	});

	SpeechRec.on_error(function(e) {
		var x = { 'name': e.name, 'message': e.message };
		console.error('▲コールバック関数 on_error が実行されました at ' + (new Date).toLocaleString() + '\n' + JSON.stringify(x));
	});
	SpeechRec.on_config(function(config){
		console.info('▲コールバック関数 on_config が実行されました( 音声認識を設定しました ): ' + JSON.stringify(config));
	});
	SpeechRec.on_start(function(){
		console.info('▲コールバック関数 on_start が実行されました( 音声認識を開始しました)');
	});
	SpeechRec.on_stop(function(){
		console.info('▲コールバック関数 on_stop が実行されました( 音声認識を停止しました / ユーザ操作 )');
	});
	SpeechRec.on_ask(function() {
		console.info('▲コールバック関数 on_ask が実行されました( マイクの使用可否を確認中です )');
	});
	SpeechRec.on_allow(function() {
		console.info('▲コールバック関数 on_allow が実行されました( マイクの使用が許可されました )');
	});
	SpeechRec.on_deny(function() {
		console.info('▲コールバック関数 on_deny が実行されました( マイクの使用が拒否されました )');
	});
	SpeechRec.on_voiceless(function(){
		console.warn('▲コールバック関数 on_voiceless が実行されました( 音声認識を停止しました / 始端が検出できませんでした )');
	});
	SpeechRec.on_voice_begin(function(){
		console.warn('▲コールバック関数 on_voice_begin が実行されました( 始端が検出されました ) at ' + (new Date).toLocaleString());
	});
	SpeechRec.on_voice_too_long(function(){
	});
	SpeechRec.on_voice_end(function(){
		console.warn('▲コールバック関数 on_voice_end が実行されました( 終端が検出されました ) at ' + (new Date).toLocaleString());
	});
	SpeechRec.on_no_result(function(){
		console.warn('▲コールバック関数 on_no_result が実行されました( 音声認識を停止しました / 認識結果が得られませんでした ) at ' + (new Date).toLocaleString());
	});
	SpeechRec.on_mic_disabled(function(){
		console.info('▲コールバック関数 on_mic_disabled が実行されました( マイクが無効化されました )');
	});
	SpeechRec.on_mic_enabled(function(){
		console.info('▲コールバック関数 on_mic_enabled が実行されました( マイクが有効化されました )');
	});

	SpeechRec.on_error(function(e){
		jQuery('#config_button').attr('disabled', false);
		jQuery('#start_button').attr('disabled', false);
	});
	SpeechRec.on_config(function(config){
		jQuery('#config_button').attr('disabled', false);
		jQuery('#start_button').attr('disabled', false);
	});
	SpeechRec.on_stop(function(){
		jQuery('#config_button').attr('disabled', false);
		jQuery('#start_button').attr('disabled', false);
	});
	SpeechRec.on_deny(function(e) {
		jQuery('#config_button').attr('disabled', false);
		jQuery('#start_button').attr('disabled', false);
	});
	SpeechRec.on_voiceless(function(){
		jQuery('#config_button').attr('disabled', false);
		jQuery('#start_button').attr('disabled', false);
	});
	SpeechRec.on_voice_too_long(function(){
		jQuery('#config_button').attr('disabled', false);
		jQuery('#start_button').attr('disabled', false);
	});
	SpeechRec.on_no_result(function(){
		jQuery('#config_button').attr('disabled', false);
		jQuery('#start_button').attr('disabled', false);
	});
	SpeechRec.on_result(function(result){
		jQuery('#config_button').attr('disabled', false);
		jQuery('#start_button').attr('disabled', false);
	});

	jQuery('#config_button').click(function(){
		SpeechRec.show_preference(function(conf){
			console.info('▼API関数 config を実行します( 音声認識を設定します ): ' + JSON.stringify(conf));
		});
	});

	var Self = window.Self = {};
	Self.resize_content = function(){
		var ww = document.documentElement.clientWidth;
		var wh = document.documentElement.clientHeight;

		var cw = jQuery('#content_div').css('width').replace(/px$/, '');
		var ch = jQuery('#content_div').css('height').replace(/px$/, '');

		var cx = (ww - cw) / 2;
		var cy = (wh - ch) / 2;

		jQuery('#content_div').css('left', cx).css('top', cy);
	};
	Self.resize_content();
	jQuery(window).resize(function(){
		Self.resize_content();
	});

	SpeechRec.config({ 'OpusWorkerUrl':'./js/libopus.worker.js' });

window.setTimeout(function(){

    jQuery('#start_button').attr('disabled', true);

    SpeechRec.show_recognition(function(){
       console.info('▼API関数 start を実行します( 音声認識を開始します )');
        jQuery('#result_textarea').val('');
        jQuery('#result_textarea').html('');
    }, function(){
          console.info('▼API関数 stop を実行します( 音声認識を停止します )');
    });

  }, 100);

});

</script>
</head>
<body>
<div id="content_div" style="text-align:center; position:absolute" >
	<button id="config_button" class="buttons" >設定</button>
	<textarea id="result_textarea" style="width:480px; height:240px;" disabled></textarea>
</div>
</body>
</html>
